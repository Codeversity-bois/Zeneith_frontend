<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AI Interview Room - Zenith</title>

    <link rel="icon" type="image/png" href="/logo_zeneith.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/src/styles/main.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: '#2463eb',
                        'primary-dark': '#1d4ed8',
                        'primary-light': '#3b82f6',
                        'background-light': '#f6f6f8',
                        'background-dark': '#111621',
                        'background-darker': '#0a0d14',
                        'surface-dark': '#1a202c',
                        success: '#16a34a',
                        error: '#dc2626',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'sound-wave': 'soundWave 1.2s ease-in-out infinite',
                    },
                    keyframes: {
                        soundWave: {
                            '0%, 100%': { height: '20%' },
                            '50%': { height: '100%' },
                        }
                    }
                },
            },
        }
    </script>

    <style>
        /* Custom styles specific to the interview room */
        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            height: 100%;
        }

        /* Audio Visualizer Bars */
        .bar {
            width: 6px;
            background: linear-gradient(to top, #2463eb, #3b82f6);
            border-radius: 9999px;
            animation: soundWave 1s ease-in-out infinite;
        }
        .bar:nth-child(odd) { animation-duration: 0.8s; }
        .bar:nth-child(2n) { animation-duration: 1.1s; }
        .bar:nth-child(3n) { animation-duration: 1.3s; }
        .bar:nth-child(4n) { animation-duration: 0.9s; }

        /* Glass Control Bar */
        .control-bar {
            background: rgba(26, 32, 44, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Syntax highlighting mock */
        .code-keyword { color: #c678dd; }
        .code-function { color: #61afef; }
        .code-string { color: #98c379; }
        .code-comment { color: #5c6370; font-style: italic; }
    </style>
</head>

<body class="bg-background-dark font-sans text-white h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-white">

    <header class="h-16 flex items-center justify-between px-6 flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="bg-primary/20 p-1.5 rounded-lg">
                <span class="material-symbols-outlined text-[24px]" style="color: #2463eb;">all_inclusive</span>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Zenith AI Interviewer</h1>
                <p class="text-xs text-slate-400">Technical Assessment • Frontend Engineering</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-surface-dark px-3 py-1.5 rounded-full border border-slate-700">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-sm font-medium font-mono">14:32</span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden p-4 pt-0 gap-4">
        
        <div class="flex-1 flex flex-col relative transition-all duration-300" id="main-stage">
            
            <div class="flex-1 bg-surface-dark rounded-2xl border border-slate-700 relative overflow-hidden flex flex-col items-center justify-center shadow-2xl">
                
                <div class="relative z-10 flex flex-col items-center gap-6">
                    <div class="relative">
                        <div class="absolute inset-0 blur-[60px] opacity-20 rounded-full animate-pulse-slow" style="background-color: #2463eb;"></div>
                        <div class="w-32 h-32 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-600 flex items-center justify-center shadow-xl relative z-10">
                            <span class="material-symbols-outlined text-5xl" style="color: #2463eb;">smart_toy</span>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-green-500 border-4 border-surface-dark w-8 h-8 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-[14px] font-bold">mic</span>
                        </div>
                    </div>

                    <div class="h-12 flex items-end gap-1.5">
                        <div class="bar h-8"></div>
                        <div class="bar h-12"></div>
                        <div class="bar h-6"></div>
                        <div class="bar h-10"></div>
                        <div class="bar h-14"></div>
                        <div class="bar h-8"></div>
                        <div class="bar h-4"></div>
                    </div>
                    
                    <div class="text-center">
                        <h2 class="text-xl font-semibold">Zenith AI</h2>
                        <p class="text-sm text-slate-400">Listening...</p>
                    </div>
                </div>

                <div class="absolute bottom-8 left-0 right-0 px-12 text-center z-20">
                    <div class="inline-block bg-black/60 backdrop-blur-sm px-6 py-3 rounded-xl text-lg font-medium text-slate-100 shadow-lg" id="current-question">
                        "Could you explain how the React Virtual DOM differs from the real DOM?"
                    </div>
                </div>

                <!-- Transcript Container (hidden by default, can be toggled) -->
                <div class="absolute top-4 left-4 w-96 bg-black/80 backdrop-blur-sm rounded-xl border border-slate-700 p-4 max-h-96 overflow-y-auto hidden" id="transcript-container">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-slate-300">Transcript</h3>
                        <button onclick="document.getElementById('transcript-container').classList.add('hidden')" class="text-slate-400 hover:text-white">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="space-y-3" id="transcript-messages"></div>
                </div>

            </div>
        </div>

        <aside class="w-96 bg-surface-dark rounded-2xl border border-slate-700 flex flex-col shadow-xl hidden md:flex transition-all duration-300 transform translate-x-0" id="side-panel">
            
            <!-- Top Half: Candidate Camera -->
            <div class="h-1/2 p-4 border-b border-slate-700 flex flex-col">
                <div class="flex-1 bg-black rounded-xl border border-slate-600 shadow-2xl overflow-hidden relative">
                    <video id="user-camera-feed" autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <div class="absolute inset-0 flex items-center justify-center bg-slate-800" id="user-camera-off">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-4xl text-slate-500 mb-2">videocam_off</span>
                            <p class="text-xs text-slate-400">Camera initializing...</p>
                        </div>
                    </div>
                    <div class="absolute bottom-2 left-3 text-xs font-medium text-white/90 bg-black/50 px-2 py-0.5 rounded">You</div>
                    
                    <!-- Recording Indicator -->
                    <div class="absolute top-2 left-2 flex items-center gap-1.5 bg-red-500/90 text-white text-[10px] font-bold px-2 py-1 rounded" id="recording-indicator">
                        <span class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>
                        <span>RECORDING</span>
                    </div>
                    
                    <!-- Microphone Indicator -->
                    <div class="absolute top-2 right-2 p-1 rounded-full" style="background-color: rgba(36, 99, 235, 0.9);" id="mic-indicator">
                        <span class="material-symbols-outlined text-[14px] text-white">mic</span>
                    </div>
                </div>
            </div>

            <!-- Bottom Half: Live Session Status -->
            <div class="h-1/2 flex flex-col border-t border-slate-700">
                <div class="p-4 border-b border-slate-700">
                    <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]" style="color: #2463eb;">security</span>
                        Live Session Status
                    </h3>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="proctoring-alerts">
                    <!-- Proctoring alerts will be dynamically added here -->
                    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-3">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <p class="text-sm text-slate-300">Session monitoring active</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <footer class="h-20 flex items-center justify-center px-6 gap-4 relative z-20">
        
        <div class="absolute left-6 hidden md:flex items-center gap-3">
            <span class="text-sm font-medium text-slate-300">Interview ID:</span>
            <span class="text-sm font-mono text-slate-500 bg-slate-800 px-2 py-1 rounded select-all">znth-882-xj9</span>
            <button class="text-slate-500 hover:text-white"><span class="material-symbols-outlined text-[18px]">content_copy</span></button>
        </div>

        <div class="control-bar px-6 py-3 rounded-full flex items-center gap-4 shadow-2xl">
            
            <button class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition-all group relative" onclick="toggleState(this, 'mic')">
                <span class="material-symbols-outlined text-white group-hover:scale-110 transition-transform">mic</span>
                <span class="absolute -top-10 bg-slate-800 text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Mute (Ctrl+D)</span>
            </button>

            <div class="w-px h-8 bg-slate-600 mx-2"></div>

            <button class="w-16 h-10 rounded-full bg-red-600 hover:bg-red-700 flex items-center justify-center transition-all shadow-lg shadow-red-900/20" onclick="window.location.href='/candidate-dashboard.html'">
                <span class="material-symbols-outlined text-white">call_end</span>
            </button>
        </div>

    </footer>

    <script type="module">
        import interviewService from '/src/js/interview-service.js';

        // State
        let sessionStarted = false;
        let cameraReady = false;
        let micReady = false;
        const transcriptContainer = document.getElementById('transcript-messages');
        const proctoringContainer = document.getElementById('proctoring-alerts');
        const timerElement = document.querySelector('.font-mono');
        const currentQuestionElement = document.getElementById('current-question');
        const micIndicator = document.getElementById('mic-indicator');
        let startTime = null;
        let timerInterval = null;

        // Initialize interview service callbacks
        interviewService.onTranscriptUpdate = (turn) => {
            addTranscriptMessage(turn);
        };

        interviewService.onEvaluationUpdate = (evaluation) => {
            console.log('Evaluation update:', evaluation);
            // Update UI with evaluation data if needed
        };

        interviewService.onProctoringAlert = (alert) => {
            addProctoringAlert(alert);
        };

        interviewService.onStatusUpdate = (status) => {
            updateTimer(status.elapsed_mins || 0);
        };

        interviewService.onError = (error) => {
            console.error('Interview service error:', error);
            alert(`Error: ${error.message}`);
        };

        // Add transcript message
        function addTranscriptMessage(turn) {
            if (!transcriptContainer) return;

            const isAI = turn.role === 'interviewer';
            const time = new Date(turn.timestamp).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${isAI ? '' : 'flex-row-reverse'}`;
            
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full ${isAI ? 'bg-primary/20' : 'bg-blue-500/20'} flex items-center justify-center ${isAI ? 'text-[#2463eb]' : 'text-blue-500'} shrink-0">
                    ${isAI ? '<span class="material-symbols-outlined text-[16px]">smart_toy</span>' : '<span class="text-xs font-bold">ME</span>'}
                </div>
                <div class="flex-1 ${isAI ? '' : 'text-right'}">
                    <div class="flex items-center ${isAI ? 'justify-between' : 'justify-end gap-2'} mb-1">
                        ${isAI ? `<span class="text-xs font-bold text-slate-300">Zenith AI</span>` : ''}
                        <span class="text-[10px] text-slate-500">${time}</span>
                        ${!isAI ? '<span class="text-xs font-bold text-slate-300">You</span>' : ''}
                    </div>
                    <p class="text-sm text-slate-300 leading-relaxed ${isAI ? 'bg-slate-800/50 rounded-lg rounded-tl-none' : 'bg-blue-500/10 rounded-lg rounded-tr-none'} p-3 ${isAI ? '' : 'text-left'}">
                        ${turn.text}
                    </p>
                </div>
            `;

            if (transcriptContainer) {
                transcriptContainer.appendChild(messageDiv);
                transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
                
                // Show transcript container if hidden
                const container = document.getElementById('transcript-container');
                if (container) {
                    container.classList.remove('hidden');
                }
            }

            // Update current question if it's from AI
            if (isAI && currentQuestionElement) {
                currentQuestionElement.textContent = `"${turn.text}"`;
            }
        }

        // Add proctoring alert
        function addProctoringAlert(alert) {
            if (!proctoringContainer) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = 'bg-red-500/10 border border-red-500/30 rounded-lg p-3 space-y-2';
            
            const timeAgo = getTimeAgo(alert.timestamp);
            const iconMap = {
                'multiple_faces': 'warning',
                'eyes_not_detected': 'visibility_off',
                'person_left': 'person_off',
                'noise_detected': 'volume_up',
                'default': 'error'
            };
            const icon = iconMap[alert.type] || iconMap.default;

            alertDiv.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="material-symbols-outlined text-red-500 text-[18px] shrink-0">${icon}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-red-400">${alert.message}</p>
                        ${alert.details ? `<p class="text-xs text-red-300/80 mt-1">${alert.details}</p>` : ''}
                        <span class="text-[10px] text-red-400/60 mt-1 block">${timeAgo}</span>
                    </div>
                </div>
            `;

            // Insert at the beginning (most recent first)
            const statusDiv = proctoringContainer.querySelector('.bg-slate-800\\/50');
            if (statusDiv) {
                proctoringContainer.insertBefore(alertDiv, statusDiv);
            } else {
                proctoringContainer.appendChild(alertDiv);
            }

            // Limit to 10 alerts
            const alerts = proctoringContainer.querySelectorAll('.bg-red-500\\/10');
            if (alerts.length > 10) {
                alerts[alerts.length - 1].remove();
            }
        }

        // Get time ago string
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        }

        // Update timer
        function updateTimer(elapsedMins) {
            if (timerElement) {
                const totalSeconds = Math.floor(elapsedMins * 60);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Start timer
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000 / 60;
                updateTimer(elapsed);
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Initialize interview session
        async function initializeInterview() {
            try {
                // Show loading state
                showCameraStatus('Requesting camera and microphone permissions...', 'info');

                // Request camera and microphone permissions first
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 }, 
                            height: { ideal: 480 },
                            frameRate: { ideal: 30 }
                        },
                        audio: { 
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });

                    // Display video preview immediately
                    const videoElement = document.getElementById('user-camera-feed');
                    if (videoElement) {
                        videoElement.srcObject = stream;
                        await videoElement.play();
                        cameraReady = true;
                        micReady = true;
                        
                        // Hide camera off indicator
                        const cameraOffElement = document.getElementById('user-camera-off');
                        if (cameraOffElement) {
                            cameraOffElement.classList.add('hidden');
                        }
                        
                        showCameraStatus('Camera and microphone active', 'success');
                        console.log('✅ Camera and microphone permissions granted');
                    }

                    // Store stream temporarily for interview service to use
                    window._tempMediaStream = stream;

                } catch (error) {
                    console.error('Failed to get camera/microphone access:', error);
                    showCameraStatus('Camera/Microphone access denied. Please allow permissions.', 'error');
                    alert('Camera and microphone access is required for the AI interview. Please allow permissions and refresh the page.');
                    return;
                }

                // Get candidate data from URL params or localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const candidateId = urlParams.get('candidate_id') || localStorage.getItem('candidate_id') || 'demo-candidate-1';
                const jobId = urlParams.get('job_id') || localStorage.getItem('job_id') || 'demo-job-1';
                const jobDescription = urlParams.get('job_description') || localStorage.getItem('job_description') || 'Frontend Engineering Position';

                showCameraStatus('Connecting to AI Interview Service...', 'info');

                // Start session
                const sessionData = await interviewService.startSession({
                    candidate_id: candidateId,
                    job_id: jobId,
                    job_description: jobDescription,
                });

                console.log('Session started:', sessionData);
                sessionStarted = true;

                showCameraStatus('Establishing secure connections...', 'info');

                // Connect WebSockets
                await interviewService.connectAudio();
                await interviewService.connectVideo();

                // Start status updates
                interviewService.startStatusUpdates();
                startTimer();

                showCameraStatus('Interview ready! AI is listening...', 'success');
                
                // Auto-hide status after 3 seconds
                setTimeout(() => {
                    const statusEl = document.getElementById('camera-status');
                    if (statusEl) {
                        statusEl.style.opacity = '0';
                        setTimeout(() => statusEl.remove(), 300);
                    }
                }, 3000);

            } catch (error) {
                console.error('Failed to initialize interview:', error);
                showCameraStatus(`Failed to start interview: ${error.message}`, 'error');
                alert(`Failed to start interview: ${error.message}`);
            }
        }

        // Show camera status notification
        function showCameraStatus(message, type = 'info') {
            let statusEl = document.getElementById('camera-status');
            
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'camera-status';
                statusEl.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-50 transition-all duration-300';
                document.body.appendChild(statusEl);
            }

            // Set colors based on type
            statusEl.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
            if (type === 'success') {
                statusEl.classList.add('bg-green-500');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-500');
            } else if (type === 'warning') {
                statusEl.classList.add('bg-yellow-500');
            } else {
                statusEl.classList.add('bg-blue-500');
            }

            statusEl.innerHTML = `
                <div class="flex items-center gap-3 text-white">
                    ${type === 'success' ? '<span class="material-symbols-outlined">check_circle</span>' : 
                      type === 'error' ? '<span class="material-symbols-outlined">error</span>' : 
                      type === 'warning' ? '<span class="material-symbols-outlined">warning</span>' : 
                      '<span class="material-symbols-outlined animate-spin">progress_activity</span>'}
                    <span class="font-medium">${message}</span>
                </div>
            `;
            statusEl.style.opacity = '1';
        }

        // Button State Toggler
        function toggleState(btn, iconName) {
            const icon = btn.querySelector('.material-symbols-outlined');
            const isOff = btn.classList.contains('bg-red-500');
            
            if (iconName === 'mic') {
                const isMuted = interviewService.toggleMute();
                if (isMuted) {
                    btn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
                    btn.classList.add('bg-red-500', 'hover:bg-red-600');
                    icon.innerText = 'mic_off';
                    if (micIndicator) {
                        micIndicator.style.backgroundColor = 'rgba(220, 38, 38, 0.9)';
                        micIndicator.querySelector('span').innerText = 'mic_off';
                    }
                } else {
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                    icon.innerText = 'mic';
                    if (micIndicator) {
                        micIndicator.style.backgroundColor = 'rgba(36, 99, 235, 0.9)';
                        micIndicator.querySelector('span').innerText = 'mic';
                    }
                }
            } else {
                if (isOff) {
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                    icon.innerText = iconName;
                } else {
                    btn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
                    btn.classList.add('bg-red-500', 'hover:bg-red-600');
                    icon.innerText = iconName + '_off';
                }
            }
        }

        // End call handler
        async function endCall() {
            if (!sessionStarted) {
                window.location.href = '/candidate-dashboard.html';
                return;
            }

            if (confirm('Are you sure you want to end the interview?')) {
                try {
                    stopTimer();
                    interviewService.stopStatusUpdates();
                    const result = await interviewService.endSession();
                    console.log('Session ended:', result);
                    window.location.href = '/candidate-dashboard.html';
                } catch (error) {
                    console.error('Failed to end session:', error);
                    alert(`Error ending session: ${error.message}`);
                }
            }
        }

        // Update end call button
        const endCallBtn = document.querySelector('button[onclick*="candidate-dashboard"]');
        if (endCallBtn) {
            endCallBtn.onclick = endCall;
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeInterview);
        } else {
            initializeInterview();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (sessionStarted) {
                interviewService.endSession().catch(console.error);
            }
        });
    </script>
</body>
</html>